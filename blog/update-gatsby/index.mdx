---
title: Gatsbyのバージョンを2から4にあげた
date: 2021-10-31
---

このサイトはGatsby.jsで構築していて久しぶりに見たらGatsbyのメジャーバージョンが2から4に上がっていたのでアップデートした。

個人的にハマったところ

## 環境

```shell
$ npx gatsby info

  System:
    OS: Linux 5.4 Debian GNU/Linux 10 (buster) 10 (buster)
    CPU: (8) arm64 unknown
    Shell: 5.7.1 - /usr/bin/zsh
  Binaries:
    Node: 16.10.0 - ~/.anyenv/envs/nodenv/versions/16.10.0/bin/node
    Yarn: 1.22.11 - ~/.anyenv/envs/nodenv/versions/16.10.0/bin/yarn
    npm: 7.24.1 - ~/.anyenv/envs/nodenv/versions/16.10.0/bin/npm
  Browsers:
    Firefox: 78.15.0esr
  npmPackages:
    gatsby: ^4.0.2 => 4.0.2
    gatsby-plugin-image: ^2.0.0 => 2.0.0
    gatsby-plugin-layout: ^3.0.0 => 3.0.0
    gatsby-plugin-mdx: ^3.0.0 => 3.0.0
    gatsby-plugin-sharp: ^4.0.1 => 4.0.1
    gatsby-remark-copy-linked-files: ^5.0.0 => 5.0.0
    gatsby-remark-images: ^6.0.0 => 6.0.0
    gatsby-source-filesystem: ^4.0.0 => 4.0.0
    gatsby-transformer-yaml: ^4.0.0 => 4.0.0
```

## sharpのインストールでこける
エラーログ
```shell
➜  blog git:(feature/transition-to-spectrum) ✗ npm install                                 
npm WARN deprecated svgo@1.3.2: This SVGO version is no longer supported. Upgrade to v2.x.x.
npm ERR! code 1
npm ERR! path /home/nabe/dev/blog/node_modules/sharp
npm ERR! command failed
npm ERR! command sh -c (node install/libvips && node install/dll-copy && prebuild-install) || (node install/can-compile && node-gyp rebuild && node install/dll-copy)
npm ERR! sharp: Please see https://sharp.pixelplumbing.com/install for required dependencies
npm ERR! sharp: Installation error: Use with glibc 2.28 requires manual installation of libvips >= 8.11.3

npm ERR! A complete log of this run can be found in:
npm ERR!     /home/nabe/.npm/_logs/2021-10-29T10_11_54_592Z-debug.log
```

apt でインストールできる libvips のバージョンが `8.7` とかで古いのでマニュアルインストールするしかなかった。

[Building libvips from a source tarball](https://www.libvips.org/install.html) 通りにインストールし、解決。

## developビルド と productionビルドでレイアウトが崩れる

gatsby develop コマンドで開発サーバー起動して開発して、いざ gatsby build && serve してみるとレイアウトが崩れている...。

https://github.com/gatsbyjs/gatsby/issues/8560#issuecomment-535265414

https://www.gatsbyjs.com/docs/conceptual/overview-of-the-gatsby-build-process/


## 感想
それでもページ遷移時にアンマウントされるのかカラーモードが初期値に戻ったり挙動が怪しくて、
静的サイトジェネレーターの良さは分かるんだけど、ちょっとしたサイト作るのにgatsbyのお作法覚えて、ビルドエラー解決してとかしていると
最適化にこだわるのってそんなに大事かなあって思っちゃう。
将来HTTP/50　とかになってネットワーク爆速になったら、1msのリソースのフェッチを削るのに頑張ってもなあってなると思うんだけど。。

